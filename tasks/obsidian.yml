---
- name: Install Obsidian via snap
  community.general.snap:
    name: obsidian
    classic: true
    state: present

- name: Create Obsidian vault directory
  ansible.builtin.file:
    path: /home/{{ username }}/Notes/Default
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0755"

- name: Extract .obsidian configuration to vault
  ansible.builtin.unarchive:
    src: "{{ playbook_dir }}/files/.obsidian.zip"
    dest: /home/{{ username }}/Notes/Default
    owner: "{{ username }}"
    group: "{{ username }}"
    creates: /home/{{ username }}/Notes/Default/.obsidian

- name: Ensure Obsidian config directory exists
  ansible.builtin.file:
    path: /home/{{ username }}/snap/obsidian/current/.config/obsidian
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0755"

- name: Ensure Obsidian Daily Notes directory exists
  ansible.builtin.file:
    path: /home/{{ username }}/Notes/Default/Daily Notes
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0755"

- name: Ensure Obsidian Templates directory exists
  ansible.builtin.file:
    path: /home/{{ username }}/Notes/Default/Templates
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0755"

- name: Copy Daily Note Template
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/files/Daily Note Template.md"
    dest: /home/{{ username }}/Notes/Default/Templates/Daily Note Template.md
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0644"

- name: Configure Obsidian vault
  ansible.builtin.copy:
    dest: /home/{{ username }}/snap/obsidian/current/.config/obsidian/obsidian.json
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0644"
    content: |
      {
        "vaults": {
          "default": {
            "path": "/home/{{ username }}/Notes/Default",
            "ts": {{ ansible_date_time.epoch }}000,
            "open": true
          }
        }
      }

- name: Open Obsidian at vault directory
  ansible.builtin.command:
    cmd: snap run obsidian obsidian://open?vault=Default --disable-gpu
  become_user: "{{ username }}"
  environment:
    DISPLAY: ":0"
  changed_when: false
  ignore_errors: true
